<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Reporte | JW Tiempo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header-user">
        <h2 id="nombreUsuario">Cargando...</h2>
        <div class="user-info">
            <span id="mesAnio"></span>
            <button id="btnCerrarSesion" class="btn btn-secondary">Cerrar Sesión</button>
        </div>
    </div>

    <div class="container">
        <div id="mensaje"></div>

        <div class="card">
            <h2 style="color: var(--primary-blue); margin-bottom: 1.5rem;">Reporte de Predicación</h2>
            
            <div id="mensajeReporteExistente" class="mensaje info" style="display: none;">
                Ya has enviado un reporte para este mes. Puedes actualizarlo completando el formulario nuevamente.
            </div>

            <form id="formReporte">
                <div class="form-group">
                    <label>¿Predicaste este mes? *</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="predico" value="si" id="predicoSi" required>
                            Sí
                        </label>
                        <label>
                            <input type="radio" name="predico" value="no" id="predicoNo" required>
                            No
                        </label>
                    </div>
                </div>

                <div class="form-group" id="grupoPrecursor" style="display: none;">
                    <label>
                        <input type="checkbox" id="esPrecursorMes" name="esPrecursorMes">
                        Marcar como Precursor este mes
                    </label>
                </div>

                <div class="form-group" id="grupoHoras" style="display: none;">
                    <label for="horas">Horas de Predicación *</label>
                    <input type="number" id="horas" name="horas" min="0" step="0.5" value="0">
                </div>

                <div class="form-group">
                    <button type="button" id="btnAgregarNota" class="btn btn-secondary">+ Agregar nota (opcional)</button>
                </div>
                <div class="form-group" id="grupoNota" style="display: none;">
                    <label for="nota">Nota</label>
                    <textarea id="nota" name="nota" placeholder="Cualquier información adicional que desees agregar..."></textarea>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%;">Enviar Reporte</button>
            </form>
        </div>

        <div class="card">
            <h2 style="color: var(--primary-blue); margin-bottom: 1.5rem;">Historial de Reportes</h2>
            <div id="historialReportes" class="historial-reportes">
                <div class="loading">Cargando historial...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCcGCZ3Sa6J4yLbPCP2XVd6MYtiKNIq8W0",
            authDomain: "jwtiempoorg.firebaseapp.com",
            databaseURL: "https://jwtiempoorg-default-rtdb.firebaseio.com",
            projectId: "jwtiempoorg",
            storageBucket: "jwtiempoorg.firebasestorage.app",
            messagingSenderId: "58182089719",
            appId: "1:58182089719:web:fd671c8b7320f55befccf2",
            measurementId: "G-232M4QXQDW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        let usuarioActual = null;
        let datosUsuario = null;

        const nombreUsuario = document.getElementById('nombreUsuario');
        const mesAnio = document.getElementById('mesAnio');
        const btnCerrarSesion = document.getElementById('btnCerrarSesion');
        const mensajeDiv = document.getElementById('mensaje');
        const formReporte = document.getElementById('formReporte');
        const predicoSi = document.getElementById('predicoSi');
        const predicoNo = document.getElementById('predicoNo');
        const grupoHoras = document.getElementById('grupoHoras');
        const grupoPrecursor = document.getElementById('grupoPrecursor');
        const grupoNota = document.getElementById('grupoNota');
        const btnAgregarNota = document.getElementById('btnAgregarNota');
        const mensajeReporteExistente = document.getElementById('mensajeReporteExistente');
        const historialReportes = document.getElementById('historialReportes');

        function mostrarMensaje(texto, tipo) {
            mensajeDiv.innerHTML = `<div class="mensaje ${tipo}">${texto}</div>`;
            setTimeout(() => { mensajeDiv.innerHTML = ''; }, 5000);
        }

        function obtenerMesAnio() {
            const ahora = new Date();
            return { año: ahora.getFullYear(), mes: String(ahora.getMonth() + 1).padStart(2, '0'), mesNombre: meses[ahora.getMonth()] };
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'publicador-login.html'; return; }
            usuarioActual = user;

            try {
                const userSnapshot = await get(ref(database, `usuarios/${user.uid}`));
                if (userSnapshot.exists()) {
                    datosUsuario = userSnapshot.val();
                    nombreUsuario.textContent = datosUsuario.nombre;
                } else {
                    datosUsuario = { nombre: user.displayName || user.email || 'Usuario' };
                    nombreUsuario.textContent = datosUsuario.nombre;
                }
                const { mesNombre } = obtenerMesAnio();
                mesAnio.textContent = `${mesNombre} ${new Date().getFullYear()}`;
                await cargarReporteActual();
                await cargarHistorial();
            } catch (error) {
                console.error('Error al cargar datos:', error);
                datosUsuario = { nombre: user.email || 'Usuario' };
                nombreUsuario.textContent = datosUsuario.nombre;
                mesAnio.textContent = `${meses[new Date().getMonth()]} ${new Date().getFullYear()}`;
                mostrarMensaje('Hubo un problema al cargar algunos datos. Puedes intentar enviar tu reporte.', 'info');
            }
        });

        async function cargarReporteActual() {
            if (!usuarioActual) return;
            const { año, mes } = obtenerMesAnio();
            const reporteRef = ref(database, `reportes/${año}/${mes}/${usuarioActual.uid}`);
            try {
                const snapshot = await get(reporteRef);
                if (snapshot.exists()) {
                    const reporte = snapshot.val();
                    mensajeReporteExistente.style.display = 'block';
                    if (reporte.predico === 'si') {
                        predicoSi.checked = true;
                        grupoPrecursor.style.display = 'block';
                        if (reporte.esPrecursor) {
                            document.getElementById('esPrecursorMes').checked = true;
                            grupoHoras.style.display = 'block';
                            document.getElementById('horas').value = reporte.horas || 0;
                        }
                    } else { predicoNo.checked = true; }
                    if (reporte.nota) {
                        grupoNota.style.display = 'block';
                        document.getElementById('nota').value = reporte.nota;
                        btnAgregarNota.textContent = '− Ocultar nota';
                    } else { grupoNota.style.display = 'none'; document.getElementById('nota').value = ''; }
                }
            } catch (error) { console.error('Error al cargar reporte actual:', error); }
        }

        async function cargarHistorial() {
            if (!usuarioActual) return;
            const ahora = new Date();
            const historial = [];
            for (let i = 0; i < 6; i++) {
                const fecha = new Date(ahora.getFullYear(), ahora.getMonth() - i, 1);
                const año = fecha.getFullYear();
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const mesNombre = meses[fecha.getMonth()];
                try {
                    const reporteRef = ref(database, `reportes/${año}/${mes}/${usuarioActual.uid}`);
                    const snapshot = await get(reporteRef);
                    if (snapshot.exists()) historial.push({ año, mes, mesNombre, ...snapshot.val() });
                } catch (e) {}
            }
            historialReportes.innerHTML = historial.length === 0 ? '<p style="text-align: center; color: var(--text-light);">No hay reportes anteriores</p>' : historial.map(r => `<div class="reporte-card"><h4>${r.mesNombre} ${r.año}</h4><p><strong>Predicó:</strong> <span class="status-${r.predico === 'si' ? 'si' : 'no'}">${r.predico === 'si' ? 'Sí' : 'No'}</span></p>${r.predico === 'si' ? `<p><strong>Horas:</strong> ${r.horas || 0}</p>` : ''}${r.esPrecursor ? '<p><strong>⭐ Precursor este mes</strong></p>' : ''}${r.nota ? `<p><strong>Nota:</strong> ${r.nota}</p>` : ''}<p style="font-size: 0.8rem; color: var(--text-light);">Enviado: ${new Date(r.fechaEnvio).toLocaleDateString('es-ES')}</p></div>`).join('');
        }

        predicoSi.addEventListener('change', () => {
            if (predicoSi.checked) {
                grupoPrecursor.style.display = 'block';
                if (!document.getElementById('esPrecursorMes').checked) grupoHoras.style.display = 'none';
            }
        });

        predicoNo.addEventListener('change', () => {
            if (predicoNo.checked) {
                grupoPrecursor.style.display = 'none';
                grupoHoras.style.display = 'none';
                document.getElementById('esPrecursorMes').checked = false;
                document.getElementById('horas').value = 0;
                document.getElementById('horas').required = false;
            }
        });

        btnAgregarNota.addEventListener('click', () => {
            if (grupoNota.style.display === 'none') {
                grupoNota.style.display = 'block';
                btnAgregarNota.textContent = '− Ocultar nota';
            } else {
                grupoNota.style.display = 'none';
                document.getElementById('nota').value = '';
                btnAgregarNota.textContent = '+ Agregar nota (opcional)';
            }
        });

        document.getElementById('esPrecursorMes').addEventListener('change', () => {
            if (document.getElementById('esPrecursorMes').checked) {
                grupoHoras.style.display = 'block';
                document.getElementById('horas').required = true;
            } else {
                grupoHoras.style.display = 'none';
                document.getElementById('horas').value = 0;
                document.getElementById('horas').required = false;
            }
        });

        formReporte.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!usuarioActual) { mostrarMensaje('Error: No se pudo verificar tu identidad. Por favor, inicia sesión nuevamente.', 'error'); return; }
            const predico = document.querySelector('input[name="predico"]:checked').value;
            const esPrecursorMes = predico === 'si' && document.getElementById('esPrecursorMes').checked;
            const horas = esPrecursorMes ? (parseFloat(document.getElementById('horas').value) || 0) : 0;
            const nota = document.getElementById('nota').value.trim();
            if (esPrecursorMes && horas <= 0) { mostrarMensaje('Si marcas como Precursor, debes ingresar las horas trabajadas', 'error'); return; }
            const { año, mes } = obtenerMesAnio();
            const nombreReporte = (datosUsuario?.nombre) || usuarioActual?.email || 'Usuario';
            try {
                await set(ref(database, `reportes/${año}/${mes}/${usuarioActual.uid}`), { predico, horas, esPrecursor: esPrecursorMes, nota, nombre: nombreReporte, fechaEnvio: new Date().toISOString() });
                mostrarMensaje('¡Reporte enviado exitosamente!', 'success');
                setTimeout(async () => {
                    await cargarReporteActual();
                    await cargarHistorial();
                    formReporte.reset();
                    grupoPrecursor.style.display = 'none';
                    grupoHoras.style.display = 'none';
                    grupoNota.style.display = 'none';
                    btnAgregarNota.textContent = '+ Agregar nota (opcional)';
                    document.getElementById('horas').required = false;
                    mensajeReporteExistente.style.display = 'block';
                }, 1000);
            } catch (error) {
                console.error('Error al enviar reporte:', error);
                mostrarMensaje('Error al enviar el reporte. Por favor, intenta nuevamente.', 'error');
            }
        });

        btnCerrarSesion.addEventListener('click', async () => {
            try { await signOut(auth); window.location.href = 'index.html'; } catch (error) { mostrarMensaje('Error al cerrar sesión.', 'error'); }
        });
    </script>
</body>
</html>
